## 1. Context

### 研究目的
光ファイバがせん断変形を受けた際に、計測された伸縮ひずみからせん断ひずみを算出する手法の精度検証。

### 解析対象
Rayleigh及びBrillouin散乱光を用いた要素試験結果。

### 前提条件
* 光ファイバセンサは一定の区間長（0.5～4.0 m）を持つ。
* せん断変形範囲: 最大1%。
* 換算式: 三平方の定理に基づく幾何変換。ε ≥ 0 のとき γ_s = √((ε+1)² − 1)、ε < 0 のとき γ_s = √(1 − (ε+1)²)。
* 理論値: 既知のせん断変位量を上記換算式に代入して算出した真のせん断ひずみ値。

### 想定スケール
* 空間解像度: 0.05 m（Rayleigh/Brillouin）
* 計測区間長: 1.0～4.0 m
* データ点数: 100～1,000点/ケース
* 解析ケース数: 最大20ケース（比較実験想定）
* せん断変形範囲: 0～1%
* ひずみ値範囲: 0～1,000 μɛ

### 計算資源制約
* 実行環境: Dockerコンテナ（macOS M4, 16GB RAM）
* 処理時間: 単一ケース < 1秒、全ケース一括処理 < 1分
* メモリ上限: データセット全体 < 100MB
* 並列化: 不要
* GPU利用: なし

### 入力データ

#### 所在・形式
* 所在: `data/` フォルダ以下
* 形式: CSVファイル
* 構造: 行が位置（単位：m）、列が伸縮ひずみ（単位：ɛ）
* 読み込み: ファイル名に基づき複数ケースを識別し、比較解析を可能にする
* 読み込み範囲：始点と終点をymlファイルで各ケース指定する
* データ例：
BASE_FILE,0mm,1mm,2mm,3mm,4mm,5mm,6mm,7mm,8mm,9mm,10mm
0,0,-1.37931E-06,-6.89655E-06,-2.75862E-06,-4.13793E-06,-2.75862E-06,-5.51724E-06,-1.37931E-06,-2.75862E-06,-2.75862E-06,-4.13793E-06
0.051,0,1.7931E-05,-3.44828E-05,1.7931E-05,-4.13793E-06,3.03448E-05,-5.51724E-06,1.7931E-05,1.7931E-05,2.06897E-05,-1.7931E-05
0.103,0,2.06897E-05,4.13793E-06,1.10345E-05,0,1.65517E-05,1.37931E-06,1.93103E-05,1.7931E-05,1.7931E-05,1.51724E-05
0.154,0,2.34483E-05,1.7931E-05,9.65517E-06,4.13793E-06,8.27586E-06,4.13793E-06,9.65517E-06,9.65517E-06,1.10345E-05,8.27586E-06
0.205,0,3.44828E-05,1.7931E-05,9.65517E-06,5.51724E-06,8.27586E-06,6.89655E-06,9.65517E-06,9.65517E-06,9.65517E-06,8.27586E-06

#### 品質要件
* 欠損値: 許容しない（前処理で線形補間）
* 外れ値: 除外しない
* 時系列性: あり（段階計測データ）

### データ処理フロー

#### 1. 前処理
* CSV読み込み
* 欠損値補間（線形補間）

#### 2. 平滑化
以下の手法を適用し比較評価（代表値は区間中央に最も近い点を中心とした**一窓**の結果のみを使用）:
* point: 区間中央に最も近い1点の換算せん断ひずみをそのまま代表値とする
* 中央値（Median）、区間平均（Moving Average）、重み付け平均: Gaussian, Triangular, Epanechnikov, Hann

#### 3. 換算
伸縮ひずみを幾何変換式によりせん断ひずみへ変換（ε の正負で上記換算式を切り替え）。

#### 4. 評価
算出値を理論値と比較し、誤差指標を算出。

### パラメータ設定（YAML管理）

#### 共通パラメータ（`params/common.yml`）
* 平滑化カーネルの窓幅（window_m）: 正の値、上限なし。窓が解析区間より大きい場合は区間を両側に広げて読み込む（expand）。
* 変換式の係数
* グラフ設定: 縦横比、フォントサイズ、凡例位置、DPI

#### ケース固有パラメータ（`params/cases/{case_id}.yml`）
* 解析対象ファイル名
* 解析区間の範囲（開始位置・終了位置）
* 当該ケースの理論値（せん断変位量から算出）

#### パラメータ選定根拠
* 窓幅: 正の値で上限は設けず、必要に応じて 4.0 m 以上も評価可能。窓が区間より大きいときは区間外データも読み込んで使用する。
* カーネル: Gaussianを基準手法とする

### 評価指標

#### 主指標
* RMSE（Root Mean Square Error）< 0.05%（実用精度要件）

#### 補助指標
* 最大誤差（Max Error）
* 平均誤差（Mean Error）
* 相関係数（Correlation Coefficient）

#### 出力形式
CSV形式でカーネル別に出力（1行1カーネル）。列: kernel（カーネル名）、RMSE、最大誤差、平均誤差、相関係数。

### 出力データ

#### グラフ
* 横軸: せん断変位（mm）
* 縦軸: 換算せん断ひずみ（%）
* プロット: 理論値を線分、各カーネルの計測値を点で表示（result.png）。カーネル別指標の比較図（metrics_comparison.png）も出力。図化用のせん断ひずみは shear_strain_for_plot.csv に保存。
* 保存形式: PNG（300 DPI）

#### 統計データ
* 各平滑化カーネルの誤差評価結果をまとめたCSV（metrics.csv）
* 列: kernel（カーネル名）、RMSE、最大誤差、平均誤差、相関係数

### 再現性・ログ管理

#### 出力管理
* ディレクトリ構造: `output/{case_id}/`
* 保存内容:
  - グラフ: result.png（理論 vs カーネル別）、metrics_comparison.png（カーネル別指標比較）
  - shear_strain_for_plot.csv（図化対象のせん断ひずみ）
  - center_position.yml（区間・代表点の位置情報）
  - metrics.csv（解析結果、カーネル別）
  - params_used/（使用したYAMLのコピー）
  - 実行ログ（run.log）

#### ログ記録内容
* 実行日時
* Pythonバージョン
* 依存ライブラリバージョン（NumPy, Pandas, Matplotlib, SciPy等）
* 使用パラメータ値
* 処理時間

#### バージョン管理
* Python: 3.12
* 主要ライブラリ:
  - NumPy: 
  - Pandas: 
  - Matplotlib: 
  - SciPy: 
  - PyYAML: 
* 固定方法: `pyproject.toml`

### 実装の留意点

#### アーキテクチャ
* PythonによるCLI実装
* Jupyter: notebooks/colab_quickstart.ipynb を参照（Colab/ローカル両対応）。実行は `python -m src.cli` または `run_single_case()` で行う。
* モジュール化を徹底し、データ読み込み、演算、図化のロジックを分離

#### モジュール構成
```
src/
├── cli.py           # エントリポイント（python -m src.cli）
├── data_loader.py   # CSV読み込み・前処理・平滑化（apply_smoothing_kernel）
├── converter.py     # ひずみ換算ロジック（εの正負で式切替）
├── evaluator.py     # 誤差評価（RMSE等算出）
└── reporter.py      # 図化・サマリーCSV・metrics_comparison出力
```

#### コーディング規約
* 型ヒント必須（Python 3.12+）
* Docstring: Google Style
* テスト: pytest による単体テスト
* フォーマット: black + isort
* リンター: ruff

### 制約・例外処理
* 入力ファイルが存在しない場合: エラーメッセージ表示後、処理中断
* 解析区間が計測範囲外の場合: 警告表示、利用可能範囲で処理継続
* メモリ不足の場合: チャンク処理に切り替え（想定外だが保険）
